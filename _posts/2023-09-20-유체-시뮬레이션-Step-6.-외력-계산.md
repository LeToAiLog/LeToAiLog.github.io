---
title: ìœ ì²´ ì‹œë®¬ë ˆì´ì…˜ Step 6. External force calculation
description: ìœ ì²´ ì‹œë®¬ë ˆì´ì…˜(Smoothed Particle Hydrodynamics)ì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ ì—¬ì„¯ ë²ˆì§¸ ê±¸ìŒ
date: 2023-09-20 23:15:32 +09:00
categories: [Smoothed Particle Hydrodynamics]
tags: [Smoothed Particle Hydrodynamics, fluid simulation, physics simulation, ìœ ì²´ ì‹œë®¬ë ˆì´ì…˜, fluid, ìœ ì²´, ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜, ì…ì ì‹œë®¬ë ˆì´ì…˜, Particles, ì…ì, SPH]
pin: true
math: true
mermaid: true
image:
  path: /assets/img/smoothed-particle-hydrodynamics/surface-tension-and-gravity.png
  # ëŒ€í‘œ ì´ë¯¸ì§€ì˜ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
  alt:
---
<!--  -->
# **External force**
<hr>

## **External force calculation**
<br>

`External force`ëŠ” ì™¸ë¶€ì—ì„œ ë°›ëŠ” í˜ìœ¼ë¡œ ê·¸ ì¢…ë¥˜ê°€ ë‹¤ì–‘í•˜ë©°, ì—¬ê¸°ì„œëŠ” `Surface tension`ê³¼ `Gravity`ë§Œ ë‹¤ë£¬ë‹¤.
<hr>

### **Gravity**
<br>

`Gravity`ë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒì€ ë§¤ìš° ì‰½ì§€ë§Œ ì£¼ì˜í•´ì•¼ í•  ì ì´ ìˆë‹¤. ìœ ì²´ëŠ” ì…ìë¡œ í•´ì„ë˜ì–´ì•¼ í•˜ë©° ë°€ë„ê°€ ê· ì¼í•˜ì§€ ì•Šë‹¤ëŠ” ì ì„ ìƒê°í•´ì•¼ í•œë‹¤. ê·¸ëŸ¬ë¯€ë¡œ `Gravity`ëŠ” ì¤‘ì‹¬ ì…ìì˜ ë°€ë„ë¡œë¶€í„° ê³„ì‚°ë˜ì–´ì•¼ í•œë‹¤.

```python
gravity[i] = GRAVITY * dens[i]
```
<hr>

### **Surface tension**
<br>

ìœ ì²´ì˜ ì…ìëŠ” ì´ì›ƒ ì…ìì˜ ì¸ë ¥ì„ ë°›ëŠ”ë‹¤. ìœ ì²´ ë‚´ë¶€ì—ì„œ ì´ëŸ¬í•œ ì…ìê°„ í˜ì€ ëª¨ë“  ë°©í–¥ì—ì„œ ë™ì¼í•˜ë©° ì„œë¡œ ê· í˜•ì„ ì´ë£¬ë‹¤. ëŒ€ì¡°ì ìœ¼ë¡œ ììœ  í‘œë©´ì—ì„œ ì…ìì— ì‘ìš©í•˜ëŠ” í˜ì€ ë¶ˆê· í˜•í•˜ë‹¤. ì•Œì§œ í˜(Surface tension)ì€ ìœ ì²´ë¥¼ í–¥í•œ í‘œë©´ ë²•ì„ (Surface normal)ë°©í–¥ìœ¼ë¡œ ì‘ìš©í•œë‹¤. ë˜í•œ í‘œë©´ì˜ ê³¡ë¥ ì„ ìµœì†Œí™”í•˜ëŠ” ê²½í–¥ì´ ìˆë‹¤. ê³¡ë¥ ì´ í´ìˆ˜ë¡ í˜ì´ ì»¤ì§„ë‹¤. `Surface tension`ì€ í‘œë©´ì„ í˜•ì„±í•˜ëŠ” ë‘ ìœ ì²´ì— ë”°ë¼ ë‹¬ë¼ì§€ëŠ” ì¥ë ¥ ê³„ìˆ˜ $\sigma$(ì‹œê·¸ë§ˆ)ì— ë”°ë¼ ë‹¬ë¼ì§„ë‹¤.

ìœ ì²´ì˜ í‘œë©´ì€ ì¶”ê°€ì ì¸ `Field quantity`ì—ì„œ ì°¾ì„ ìˆ˜ ìˆë‹¤. ì…ìì˜ ìœ„ì¹˜ì—ì„  `1`ì´ê³  ë‹¤ë¥¸ ëª¨ë“  ê³³ì—ì„œëŠ” `0`ìœ¼ë¡œ ë‚˜íƒ€ë‚œë‹¤. ì´ `Field quantity`ë¥¼ `Color field`ë¼ê³  í•˜ë©° `Smoothed color field`ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

$$
\begin{aligned}
  c_{S}(\mathbf{r}) = \sum_{j}m_{j}\frac{1}{\rho_{j}}W(\textbf{r}-\textbf{r}_{j}, h)
\end{aligned}
$$

`Smoothed color field`ì˜ `Gradient field`ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

$$
\begin{aligned}
  \textbf{n} = \nabla c_{S}
\end{aligned}
$$

ìœ ì²´ë¥¼ ê°€ë¦¬í‚¤ëŠ” `Surface normal field`ë¥¼ ìƒì„±í•˜ê³  $n$ì˜ ë°œì‚°ì€ í‘œë©´ì˜ ê³¡ë¥ ì„ ì¸¡ì •í•œë‹¤.

```python
def computeNormal(posX, posY, posZ, ntotal, particle, dens):
    normal_c = np.zeros(3)
    for i in range(ntotal):
        normal_c[0] += densKernelGradient(
            posX - particle[0][i],
            posY - particle[1][i],
            posZ - particle[2][i],
            SUPPORT_RADIUS,
            1,
        ) * (MASS / dens[i])
        normal_c[1] += densKernelGradient(
            posX - particle[0][i],
            posY - particle[1][i],
            posZ - particle[2][i],
            SUPPORT_RADIUS,
            2,
        ) * (MASS / dens[i])
        normal_c[2] += densKernelGradient(
            posX - particle[0][i],
            posY - particle[1][i],
            posZ - particle[2][i],
            SUPPORT_RADIUS,
            3,
        ) * (MASS / dens[i])
    return normal_c[0], normal_c[1], normal_c[2]
```

```python
def densKernelGradient(diffX, diffY, diffZ, r, d):
    dist = sqrt((diffX * diffX) + (diffY * diffY) + (diffZ * diffZ))
    if dist > r:
        return 0.0
    else:
        if d == 1:
            diff = diffX
        if d == 2:
            diff = diffY
        if d == 3:
            diff = diffZ
        return -(
            diff * (945.0 / (32.0 * PI * pow(r, 9.0))) * pow(r * r - dist * dist, 2.0)
        )
```

$$
\begin{aligned}
  \kappa = \frac{-\nabla^{2}c_{S}}{|\textbf{n}|}
\end{aligned}
$$

```python
def densKernelLaplacian(diffX, diffY, diffZ, r):
    dist = sqrt(diffX * diffX + diffY * diffY + diffZ * diffZ)
    if dist > r:
        return 0.0
    else:
        return -(
            (945.0 / (32.0 * PI * pow(r, 9.0)))
            * (r * r - dist * dist)
            * (3 * r * r - 7 * dist * dist)
        )
```

ë³¼ë¡í•œ ìœ ì²´ Volumeì— ëŒ€í•œ ì–‘ì˜ ê³¡ë¥ ì„ ì–»ìœ¼ë ¤ë©´ `Minus`ê°€ í•„ìš”í•˜ë‹¤. ì´ ëª¨ë“  ê²ƒì„ ì¢…í•©í•˜ë©´ `Surface traction`ì„ ì–»ì„ ìˆ˜ ìˆë‹¤.

$$
\begin{aligned}
  \textbf{t}^{\textrm{surface}} = \sigma\kappa\frac{\textbf{n}}{|\textbf{n}|}
\end{aligned}
$$

í‘œë©´ ê·¼ì²˜ì—ì„œ ì…ìë“¤ ì‚¬ì´ì— `Surface traction`ì„ ë¶„ë°°í•˜ê³  í˜ ë°€ë„ë¥¼ ì–»ê¸° ìœ„í•´ `Normalize`ëœ `Scalar field` $Î´s = |n|$ì€ í‘œë©´ ê·¼ì²˜ì—ì„œë§Œ 0ì´ ì•„ë‹ˆë‹¤. í‘œë©´ ê·¼ì²˜ì— ì‘ìš©í•˜ëŠ” í˜ ë°€ë„ì— ëŒ€í•´ ë‹¤ìŒì„ ì–»ì„ ìˆ˜ ìˆë‹¤.

$$
\begin{aligned}
  \textbf{f}^{\textrm{surface}} = \sigma \kappa \textbf{n} = - \sigma \nabla^{2}c_{S}\frac{\textbf{n}}{|\textbf{n}|}
\end{aligned}
$$

```python
def comptueSurfaceTensionForce(normal, posX, posY, posZ, iden, ntotal, particle, dens):
    weight = 0.0
    norm = sqrt(
        normal[0][iden] * normal[0][iden]
        + normal[1][iden] * normal[1][iden]
        + normal[2][iden] * normal[2][iden]
    )
    for i in range(ntotal):
        weight += (MASS / dens[i]) * densKernelLaplacian(
            posX - particle[0][i],
            posY - particle[1][i],
            posZ - particle[2][i],
            SUPPORT_RADIUS,
        )
    normal1 = normal[0][iden] / norm
    normal2 = normal[1][iden] / norm
    normal3 = normal[2][iden] / norm
    return (
        -(normal1 * SURFACE_TENSION * weight),
        -(normal2 * SURFACE_TENSION * weight),
        -(normal3 * SURFACE_TENSION * weight),
    )
```

í•˜ì§€ë§Œ $\|n\|$ì´ ì‘ì€ ìœ„ì¹˜ì—ì„œ
$\frac{\textbf{n}}{|\textbf{n}|}$ì„ í‰ê°€í•˜ë©´ ìˆ˜ì¹˜ ë¬¸ì œê°€ ë°œìƒí•œë‹¤.
$\|n\|$ì´ íŠ¹ì • `THRESHOLD`ë¥¼ ì´ˆê³¼í•˜ëŠ” ê²½ìš°ì—ë§Œ í˜ì„ í‰ê°€í•´ì•¼ í•œë‹¤.

Color field ${c_{S}}$ì™€ Gradient field ${n = \nabla c_{S}}$ëŠ” í‘œë©´ ì…ìë¥¼ ì‹ë³„í•˜ê³  í‘œë©´ Normalì„ ê³„ì‚°í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ì…ìëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš° í‘œë©´ ì…ìë¡œ ì‹ë³„ëœë‹¤.

$$
\begin{aligned}
  |\textbf{n}(\textbf{r}_{i}))| > l
\end{aligned}
$$

ì—¬ê¸°ì„œ $l$ì€ `THRESHOLD`ì´ë‹¤. ì…ì $i$ì˜ ìœ„ì¹˜ì—ì„œ ìˆ˜ì§ì¸ í‘œë©´ì˜ ë°©í–¥ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

$$
\begin{aligned}
  -\mathbf{n}(\textbf{r}_{i})
\end{aligned}
$$

```python
        for i in range(ntotal):
            gravity[i] = GRAVITY * dens[i]
            normal[0][i], normal[1][i], normal[2][i] = computeNormal(
                particle[0][i], particle[1][i], particle[2][i], ntotal, particle, dens
            )
            if (
                sqrt(
                    (normal[0][i] * normal[0][i])
                    + (normal[1][i] * normal[1][i])
                    + (normal[2][i] * normal[2][i])
                )
                >= THRESHOLD
            ):
                (
                    surfaceTensionForce[0][i],
                    surfaceTensionForce[1][i],
                    surfaceTensionForce[2][i],
                ) = comptueSurfaceTensionForce(
                    normal,
                    particle[0][i],
                    particle[1][i],
                    particle[2][i],
                    i,
                    ntotal,
                    particle,
                    dens,
                )
            else:
                for d in range(DIM):
                    surfaceTensionForce[d][i] = 0.0
```

<hr>
<!-- ì´ë¯¸ì§€ -->
<!-- ![í‰í™œ ì…ì ìœ ì²´ì—­í•™ ì»¤ë„ ê·¸ë¦¼](/assets/img/smoothed-particle-hydrodynamics/SmoothingKernelFigurewithWhiteBackground.png){:width="500" height="589" style="border:1px solid #eaeaea; border-radius: 10px; padding: 0px;"} 
_**<span style="color:deepskyblue; font-size:150%">Figure 1. </span>
<span style="color:gainsboro;font-size:150%">Particle approximation using particles within the particle range(â„), ğ‘˜â„ is the particle range, $$r_{ij}$$ is the distance between the neighbor particle and the central particle(red).</span>**_ -->